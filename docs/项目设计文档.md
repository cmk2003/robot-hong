# æƒ…æ„Ÿæœºå™¨äººé¡¹ç›®è®¾è®¡æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

åŸºäºŽMemGPTæž¶æž„å®žçŽ°çš„æƒ…æ„Ÿé™ªä¼´æœºå™¨äººï¼Œå…·å¤‡é•¿æœŸè®°å¿†èƒ½åŠ›ï¼Œèƒ½å¤Ÿï¼š
- è¯†åˆ«å’Œç†è§£ç”¨æˆ·çš„æƒ…æ„ŸçŠ¶æ€
- è®°ä½ç”¨æˆ·çš„æƒ…æ„ŸåŽ†å²å’Œé‡è¦äº‹ä»¶
- æä¾›ä¸ªæ€§åŒ–çš„æƒ…æ„Ÿæ”¯æŒå’Œé™ªä¼´
- è·¨ä¼šè¯ä¿æŒå¯¹è¯è¿žè´¯æ€§å’Œæƒ…æ„Ÿä¸€è‡´æ€§

---

## LLMé…ç½®

```python
# ä½¿ç”¨çŽ¯å¢ƒå˜é‡ç®¡ç†APIå¯†é’¥ï¼ˆè¯·å‹¿åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼‰
import os

LLM_CONFIG = {
    "api_key": os.getenv("DASHSCOPE_API_KEY"),
    "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "model": "qwen-max"  # æ”¯æŒfunction calling
}
```

> âš ï¸ è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶é…ç½® `DASHSCOPE_API_KEY`

---

## ç³»ç»Ÿæž¶æž„

### æ ¸å¿ƒæž¶æž„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æƒ…æ„Ÿæœºå™¨äººç³»ç»Ÿ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main Context (ä¸»ä¸Šä¸‹æ–‡) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ System Prompt   â”‚  â”‚ Working Context  â”‚  â”‚   FIFO Queue       â”‚  â”‚â”‚
â”‚  â”‚  â”‚ (ç³»ç»ŸæŒ‡ä»¤)       â”‚  â”‚ (å·¥ä½œä¸Šä¸‹æ–‡)      â”‚  â”‚   (æ¶ˆæ¯é˜Ÿåˆ—)        â”‚  â”‚â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚                    â”‚  â”‚â”‚
â”‚  â”‚  â”‚ - è§’è‰²è®¾å®š       â”‚  â”‚ - ç”¨æˆ·ç”»åƒ       â”‚  â”‚ - è¿‘æœŸå¯¹è¯åŽ†å²      â”‚  â”‚â”‚
â”‚  â”‚  â”‚ - æƒ…æ„Ÿåˆ†æžæŒ‡ä»¤   â”‚  â”‚ - å½“å‰æƒ…æ„ŸçŠ¶æ€   â”‚  â”‚ - ç³»ç»Ÿæ¶ˆæ¯          â”‚  â”‚â”‚
â”‚  â”‚  â”‚ - è®°å¿†ç®¡ç†è§„åˆ™   â”‚  â”‚ - é‡è¦äº‹ä»¶æ‘˜è¦   â”‚  â”‚ - å‡½æ•°è°ƒç”¨ç»“æžœ      â”‚  â”‚â”‚
â”‚  â”‚  â”‚ - å‡½æ•°å®šä¹‰       â”‚  â”‚ - ç”¨æˆ·åå¥½       â”‚  â”‚                    â”‚  â”‚â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚ - å…³ç³»è¿›å±•       â”‚  â”‚                    â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚       åªè¯»                 å¯è¯»å†™                  å¯è¯»å†™             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LLM Processor (è¯­è¨€æ¨¡åž‹å¤„ç†å™¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚ æƒ…æ„Ÿåˆ†æžå¼•æ“Ž  â”‚    â”‚ å“åº”ç”Ÿæˆå¼•æ“Ž  â”‚    â”‚ è®°å¿†ç®¡ç†å†³ç­–å¼•æ“Ž     â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                    â”‚                                     â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                      â–¼                           â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€ Function Executor â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€ Queue Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ (å‡½æ•°æ‰§è¡Œå™¨)                     â”‚  â”‚ (é˜Ÿåˆ—ç®¡ç†å™¨)                    â”‚â”‚
â”‚  â”‚                                 â”‚  â”‚                                 â”‚â”‚
â”‚  â”‚ - æƒ…æ„Ÿè®°å¿†å­˜å‚¨                   â”‚  â”‚ - æ¶ˆæ¯å…¥é˜Ÿ/å‡ºé˜Ÿ                  â”‚â”‚
â”‚  â”‚ - ç”¨æˆ·ç”»åƒæ›´æ–°                   â”‚  â”‚ - ä¸Šä¸‹æ–‡åŽ‹åŠ›æ£€æµ‹                 â”‚â”‚
â”‚  â”‚ - åŽ†å²æ£€ç´¢                       â”‚  â”‚ - é€’å½’æ‘˜è¦ç”Ÿæˆ                  â”‚â”‚
â”‚  â”‚ - äº‹ä»¶è®°å½•                       â”‚  â”‚ - å†…å­˜æº¢å‡ºå¤„ç†                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                      â”‚                           â”‚                       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Persistent Storage (æŒä¹…åŒ–å­˜å‚¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚â”‚
â”‚  â”‚                    â”‚    SQLite + FTS5          â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚                            â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚ - å¯¹è¯æ¶ˆæ¯ï¼ˆå«å…¨æ–‡ç´¢å¼•ï¼‰     â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚ - ç”¨æˆ·ç”»åƒ                  â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚ - æƒ…æ„Ÿè®°å½•                  â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚ - ç”Ÿæ´»äº‹ä»¶                  â”‚                    â”‚â”‚
â”‚  â”‚                    â”‚ - ä¼šè¯æ‘˜è¦                  â”‚                    â”‚â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚â”‚
â”‚  â”‚                                                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åˆ†å±‚å†…å­˜æž¶æž„è¯¦è§£

### 1. Main Contextï¼ˆä¸»ä¸Šä¸‹æ–‡ï¼‰- ç±»æ¯”RAM

ä¸»ä¸Šä¸‹æ–‡æ˜¯LLMåœ¨æŽ¨ç†æ—¶èƒ½ç›´æŽ¥è®¿é—®çš„ä¿¡æ¯ï¼Œåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

#### 1.1 System Promptï¼ˆç³»ç»ŸæŒ‡ä»¤ï¼‰- åªè¯»
```
å†…å®¹ï¼š
- æœºå™¨äººè§’è‰²è®¾å®šï¼ˆæ¸©æš–ã€å…±æƒ…ã€ä¸“ä¸šçš„æƒ…æ„Ÿé™ªä¼´è€…ï¼‰
- æƒ…æ„Ÿåˆ†æžæŒ‡ä»¤å’Œå“åº”ç­–ç•¥
- è®°å¿†ç®¡ç†è§„åˆ™å’Œå‡½æ•°ä½¿ç”¨è¯´æ˜Ž
- å®‰å…¨è¾¹ç•Œå’Œä¼¦ç†å‡†åˆ™
```

#### 1.2 Working Contextï¼ˆå·¥ä½œä¸Šä¸‹æ–‡ï¼‰- å¯è¯»å†™
```
å†…å®¹ï¼š
- ç”¨æˆ·ç”»åƒï¼ˆå§“åã€å¹´é¾„ã€èŒä¸šã€æ€§æ ¼ç‰¹ç‚¹ï¼‰
- å½“å‰æƒ…æ„ŸçŠ¶æ€ï¼ˆæƒ…ç»ªç±»åž‹ã€å¼ºåº¦ã€æŒç»­æ—¶é—´ï¼‰
- é‡è¦äº‹ä»¶æ‘˜è¦ï¼ˆè¿‘æœŸå‘ç”Ÿçš„å…³é”®äº‹ä»¶ï¼‰
- ç”¨æˆ·åå¥½ï¼ˆæ²Ÿé€šé£Žæ ¼ã€æ•æ„Ÿè¯é¢˜ï¼‰
- å…³ç³»è¿›å±•ï¼ˆä¿¡ä»»åº¦ã€äº’åŠ¨åŽ†å²æ¦‚è¦ï¼‰
- å¾…è·Ÿè¿›äº‹é¡¹ï¼ˆç”¨æˆ·æåˆ°çš„æœªå®Œæˆäº‹é¡¹ï¼‰
```

#### 1.3 FIFO Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰- å¯è¯»å†™
```
å†…å®¹ï¼š
- è¿‘æœŸå¯¹è¯åŽ†å²ï¼ˆæœ€è¿‘Nè½®å¯¹è¯ï¼‰
- ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå†…å­˜åŽ‹åŠ›è­¦å‘Šã€äº‹ä»¶æé†’ï¼‰
- å‡½æ•°è°ƒç”¨çš„è¾“å…¥å’Œè¾“å‡º
- é€’å½’æ‘˜è¦ï¼ˆè¢«é©±é€æ¶ˆæ¯çš„æ‘˜è¦ï¼‰
```

### 2. Persistent Storageï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰- ç±»æ¯”ç£ç›˜

ä½¿ç”¨ SQLite + FTS5 ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æŒä¹…åŒ–æ•°æ®ï¼š

```
å­˜å‚¨å†…å®¹ï¼š
- å®Œæ•´å¯¹è¯åŽ†å²ï¼ˆæ‰€æœ‰åŽ†å²æ¶ˆæ¯ï¼‰
- æƒ…æ„Ÿäº‹ä»¶æ—¶é—´çº¿ï¼ˆæƒ…æ„Ÿå˜åŒ–è®°å½•ï¼‰
- ä¼šè¯å…ƒæ•°æ®ï¼ˆæ—¶é—´ã€æŒç»­æ—¶é•¿ã€ä¸»é¢˜ï¼‰
- ç”¨æˆ·æƒ…æ„Ÿæ¡£æ¡ˆï¼ˆé•¿æœŸæƒ…æ„Ÿæ¨¡å¼ï¼‰
- é‡è¦äººç‰©å…³ç³»å›¾ï¼ˆå®¶äººã€æœ‹å‹ã€åŒäº‹ï¼‰
- ç”Ÿæ´»äº‹ä»¶åº“ï¼ˆé‡å¤§äº‹ä»¶è®°å½•ï¼‰

æ£€ç´¢æ–¹å¼ï¼š
- FTS5 å…¨æ–‡æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
- æ—¶é—´èŒƒå›´æŸ¥è¯¢
- æƒ…æ„Ÿç±»åž‹è¿‡æ»¤
- ç»“æž„åŒ–SQLæŸ¥è¯¢
```

> ðŸ’¡ **å…³äºŽå‘é‡æ•°æ®åº“**ï¼šMVPé˜¶æ®µä½¿ç”¨ SQLite FTS5 å…¨æ–‡æœç´¢å³å¯æ»¡è¶³éœ€æ±‚ã€‚å¦‚åŽç»­éœ€è¦è¯­ä¹‰æœç´¢èƒ½åŠ›ï¼Œå¯å¼•å…¥ `sqlite-vec` æ‰©å±•æˆ–è¿ç§»è‡³ ChromaDBã€‚

---

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. æƒ…æ„Ÿåˆ†æžå¼•æ“Žï¼ˆæ··åˆç­–ç•¥ï¼‰

```python
class EmotionAnalyzer:
    """æ··åˆæƒ…æ„Ÿåˆ†æžå¼•æ“Ž - è§„åˆ™ä¼˜å…ˆï¼ŒLLMå…œåº•"""
    
    æ”¯æŒçš„æƒ…æ„Ÿç±»åž‹ï¼š
    - åŸºç¡€æƒ…æ„Ÿï¼šå–œæ‚¦ã€æ‚²ä¼¤ã€æ„¤æ€’ã€ææƒ§ã€æƒŠè®¶ã€åŽŒæ¶
    - å¤æ‚æƒ…æ„Ÿï¼šç„¦è™‘ã€å­¤ç‹¬ã€å¤±æœ›ã€æ„Ÿæ¿€ã€å¸Œæœ›ã€å›°æƒ‘
    - æƒ…æ„Ÿå¼ºåº¦ï¼š0.0-1.0ï¼ˆå½’ä¸€åŒ–ï¼‰
    
    åˆ†æžç­–ç•¥ï¼š
    1. è§„åˆ™å±‚ï¼šå…³é”®è¯åŒ¹é… + æƒ…æ„Ÿè¯å…¸ï¼ˆå¿«é€Ÿã€ä½Žæˆæœ¬ï¼‰
    2. LLMå±‚ï¼šå¤æ‚æƒ…å†µè°ƒç”¨LLMåˆ†æžï¼ˆå‡†ç¡®ã€é«˜æˆæœ¬ï¼‰
    
    åˆ†æžç»´åº¦ï¼š
    - å½“å‰æƒ…æ„ŸçŠ¶æ€
    - æƒ…æ„Ÿå˜åŒ–è¶‹åŠ¿
    - æ½œåœ¨æƒ…æ„Ÿéœ€æ±‚
    - æƒ…æ„Ÿè§¦å‘å› ç´ 
    
    def analyze(self, text: str) -> EmotionResult:
        # ç¬¬ä¸€å±‚ï¼šè§„åˆ™å¿«é€Ÿåˆ†ç±»
        quick_result = self._rule_based_analysis(text)
        if quick_result.confidence > 0.8:
            return quick_result
        
        # ç¬¬äºŒå±‚ï¼šLLMæ·±åº¦åˆ†æž
        return self._llm_analysis(text)
```

### 2. è®°å¿†ç®¡ç†ç³»ç»Ÿ

```python
class MemoryManager:
    """è®°å¿†ç®¡ç†å™¨ - MemGPTæ ¸å¿ƒ"""
    
    æ ¸å¿ƒåŠŸèƒ½ï¼š
    - working_context_update()   # æ›´æ–°å·¥ä½œä¸Šä¸‹æ–‡
    - working_context_search()   # æœç´¢å·¥ä½œä¸Šä¸‹æ–‡
    - storage_insert()           # æ’å…¥æŒä¹…åŒ–å­˜å‚¨
    - storage_search()           # æœç´¢æŒä¹…åŒ–å­˜å‚¨ï¼ˆFTS5ï¼‰
    - storage_search_by_time()   # æŒ‰æ—¶é—´èŒƒå›´æ£€ç´¢
    - storage_search_by_emotion()# æŒ‰æƒ…æ„Ÿç±»åž‹æ£€ç´¢
    
    è‡ªåŠ¨åŒ–æœºåˆ¶ï¼š
    - å†…å­˜åŽ‹åŠ›æ£€æµ‹ä¸Žé¢„è­¦
    - è‡ªåŠ¨æ‘˜è¦ä¸Žä¿¡æ¯åŽ‹ç¼©
    - é‡è¦ä¿¡æ¯è¯†åˆ«ä¸ŽæŒä¹…åŒ–
    - ä¸Šä¸‹æ–‡æº¢å‡ºå¤„ç†
```

### 3. å¯¹è¯æ‘˜è¦å™¨

```python
class ConversationSummarizer:
    """å¯¹è¯æ‘˜è¦å™¨ - å¤„ç†ä¸Šä¸‹æ–‡æº¢å‡º"""
    
    SUMMARY_TRIGGER = 20  # æ¯20æ¡æ¶ˆæ¯è§¦å‘æ‘˜è¦æ£€æŸ¥
    MAX_CONTEXT_MESSAGES = 30  # æœ€å¤§ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•°
    
    æ‘˜è¦ç­–ç•¥ï¼š
    - ä¿ç•™æœ€è¿‘çš„å¯¹è¯ï¼ˆFIFO Queueï¼‰
    - æ—§æ¶ˆæ¯ç”Ÿæˆæ‘˜è¦åŽå½’æ¡£
    - æ‘˜è¦èšç„¦ï¼šæƒ…æ„Ÿå˜åŒ–ã€å…³é”®äº‹ä»¶ã€ç”¨æˆ·éœ€æ±‚
    
    async def maybe_summarize(self, messages: list) -> Optional[str]:
        if len(messages) < self.SUMMARY_TRIGGER:
            return None
        
        # å–æœ€æ—§çš„ä¸€åŠæ¶ˆæ¯è¿›è¡Œæ‘˜è¦
        to_summarize = messages[:len(messages)//2]
        
        summary = await self.llm.summarize(
            messages=to_summarize,
            focus=["æƒ…æ„Ÿå˜åŒ–", "å…³é”®äº‹ä»¶", "ç”¨æˆ·éœ€æ±‚"]
        )
        
        # å½’æ¡£åŽŸå§‹æ¶ˆæ¯ï¼Œè¿”å›žæ‘˜è¦
        await self.storage.archive_messages(to_summarize)
        return summary
```

### 4. å“åº”ç”Ÿæˆå¼•æ“Ž

```python
class ResponseGenerator:
    """å“åº”ç”Ÿæˆå™¨"""
    
    å“åº”ç­–ç•¥ï¼š
    - æƒ…æ„Ÿå…±é¸£ï¼šè¯†åˆ«æƒ…æ„Ÿå¹¶è¡¨è¾¾ç†è§£
    - ç§¯æžå€¾å¬ï¼šå¤è¿°å’Œç¡®è®¤ç”¨æˆ·æ„Ÿå—
    - æƒ…æ„Ÿæ”¯æŒï¼šæä¾›å®‰æ…°å’Œé¼“åŠ±
    - é—®é¢˜å¼•å¯¼ï¼šå¸®åŠ©ç”¨æˆ·æ·±å…¥æ€è€ƒ
    - èµ„æºæä¾›ï¼šé€‚æ—¶æä¾›æœ‰ç”¨ä¿¡æ¯
    
    ä¸ªæ€§åŒ–è¦ç´ ï¼š
    - åŸºäºŽç”¨æˆ·ç”»åƒè°ƒæ•´è¯­æ°”
    - å‚è€ƒåŽ†å²å¯¹è¯ä¿æŒä¸€è‡´æ€§
    - å¼•ç”¨è¿‡åŽ»ç»åŽ†å¢žå¼ºè¿žæŽ¥
```

### 5. äº‹ä»¶è¿½è¸ªç³»ç»Ÿ

```python
class EventTracker:
    """ç”Ÿæ´»äº‹ä»¶è¿½è¸ªå™¨"""
    
    è¿½è¸ªçš„äº‹ä»¶ç±»åž‹ï¼š
    - å·¥ä½œäº‹ä»¶ï¼šå‡èŒã€é¡¹ç›®ã€åŽ‹åŠ›
    - å…³ç³»äº‹ä»¶ï¼šæ‹çˆ±ã€å‹æƒ…ã€å®¶åº­
    - å¥åº·äº‹ä»¶ï¼šèº«ä½“çŠ¶å†µã€ç¡çœ ã€è¿åŠ¨
    - ç”Ÿæ´»äº‹ä»¶ï¼šæ¬å®¶ã€æ—…è¡Œã€çˆ±å¥½
    
    åŠŸèƒ½ï¼š
    - äº‹ä»¶è®°å½•ä¸Žåˆ†ç±»
    - äº‹ä»¶å…³è”åˆ†æž
    - å‘¨æœŸæ€§äº‹ä»¶æé†’
    - äº‹ä»¶æƒ…æ„Ÿå½±å“è¯„ä¼°
```

---

## æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ

### æ•°æ®åº“è®¾è®¡ï¼ˆSQLite + FTS5ï¼‰

#### 1. ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    profile_data JSON  -- ç”¨æˆ·ç”»åƒæ•°æ®
);

CREATE INDEX idx_users_name ON users(name);
```

#### 2. å¯¹è¯æ¶ˆæ¯è¡¨ (messages)
```sql
CREATE TABLE messages (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    session_id TEXT NOT NULL,
    role TEXT NOT NULL,           -- user/assistant/system
    content TEXT NOT NULL,
    emotion_type TEXT,            -- æƒ…æ„Ÿç±»åž‹
    emotion_intensity REAL,       -- æƒ…æ„Ÿå¼ºåº¦ 0.0-1.0
    metadata JSON,                -- æ‰©å±•å­—æ®µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- æ€§èƒ½ç´¢å¼•
CREATE INDEX idx_messages_user_time ON messages(user_id, created_at DESC);
CREATE INDEX idx_messages_session ON messages(session_id);
CREATE INDEX idx_messages_emotion ON messages(emotion_type);

-- FTS5 å…¨æ–‡æœç´¢è™šæ‹Ÿè¡¨
CREATE VIRTUAL TABLE messages_fts USING fts5(
    content,
    emotion_type,
    content=messages,
    content_rowid=rowid,
    tokenize='unicode61'
);
```

#### 3. æƒ…æ„Ÿè®°å½•è¡¨ (emotion_records)
```sql
CREATE TABLE emotion_records (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    emotion_type TEXT NOT NULL,
    intensity REAL NOT NULL,      -- 0.0-1.0
    trigger TEXT,                 -- è§¦å‘å› ç´ 
    context TEXT,                 -- ä¸Šä¸‹æ–‡
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_emotion_user_time ON emotion_records(user_id, created_at DESC);
CREATE INDEX idx_emotion_type ON emotion_records(emotion_type);
```

#### 4. ç”Ÿæ´»äº‹ä»¶è¡¨ (life_events)
```sql
CREATE TABLE life_events (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    event_type TEXT NOT NULL,     -- work/relationship/health/life
    title TEXT NOT NULL,
    description TEXT,
    importance INTEGER DEFAULT 3, -- é‡è¦ç¨‹åº¦ 1-5
    emotion_impact TEXT,          -- æƒ…æ„Ÿå½±å“
    event_date DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_events_user_date ON life_events(user_id, event_date DESC);
CREATE INDEX idx_events_type ON life_events(event_type);
```

#### 5. å·¥ä½œä¸Šä¸‹æ–‡è¡¨ (working_contexts)
```sql
CREATE TABLE working_contexts (
    id TEXT PRIMARY KEY,
    user_id TEXT UNIQUE NOT NULL,
    content JSON NOT NULL,        -- å·¥ä½œä¸Šä¸‹æ–‡å†…å®¹
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 6. ä¼šè¯è¡¨ (sessions)
```sql
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    ended_at DATETIME,
    summary TEXT,                 -- ä¼šè¯æ‘˜è¦
    main_topics JSON,             -- ä¸»è¦è¯é¢˜
    emotional_arc JSON,           -- æƒ…æ„Ÿå˜åŒ–è½¨è¿¹
    message_count INTEGER DEFAULT 0,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_sessions_user_time ON sessions(user_id, started_at DESC);
```

---

## é¡¹ç›®ç›®å½•ç»“æž„

```
æƒ…æ„Ÿæœºå™¨äºº/
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ é¡¹ç›®è®¾è®¡æ–‡æ¡£.md
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                    # ä¸»å…¥å£
â”‚   â”œâ”€â”€ config.py                  # é…ç½®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ agent/                     # æ ¸å¿ƒAgentæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ emotional_agent.py     # æƒ…æ„ŸAgentä¸»ç±»
â”‚   â”‚   â”œâ”€â”€ memory.py              # ç»Ÿä¸€è®°å¿†ç®¡ç†
â”‚   â”‚   â””â”€â”€ context.py             # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ emotion/                   # æƒ…æ„Ÿåˆ†æžæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ analyzer.py            # æ··åˆæƒ…æ„Ÿåˆ†æžå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                   # å­˜å‚¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ sqlite.py              # SQLite + FTS5 æ“ä½œ
â”‚   â”‚   â””â”€â”€ repository.py          # æ•°æ®è®¿é—®å±‚
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/                       # LLMæŽ¥å£æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ client.py              # LLMå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ prompts.py             # æç¤ºè¯æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ functions.py           # å‡½æ•°å®šä¹‰
â”‚   â”‚
â”‚   â””â”€â”€ utils/                     # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ logger.py              # æ—¥å¿—å·¥å…·
â”‚       â””â”€â”€ helpers.py             # è¾…åŠ©å‡½æ•°
â”‚
â”œâ”€â”€ data/
â”‚   â””â”€â”€ emotional_bot.db           # SQLiteæ•°æ®åº“
â”‚
â”œâ”€â”€ tests/                         # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_memory.py
â”‚   â”œâ”€â”€ test_emotion.py
â”‚   â””â”€â”€ test_agent.py
â”‚
â”œâ”€â”€ notebooks/                     # Jupyterç¬”è®°æœ¬
â”‚   â””â”€â”€ demo.ipynb                 # æ¼”ç¤ºç¬”è®°æœ¬
â”‚
â”œâ”€â”€ .env.example                   # çŽ¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore                     # Gitå¿½ç•¥é…ç½®
â”œâ”€â”€ requirements.txt               # ä¾èµ–æ–‡ä»¶
â””â”€â”€ README.md                      # é¡¹ç›®è¯´æ˜Ž
```

---

## æ ¸å¿ƒæµç¨‹

### 1. æ¶ˆæ¯å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Queue Manager   â”‚ â”€â”€â”€â”€ æ¶ˆæ¯å…¥é˜Ÿåˆ° FIFO Queue
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Emotion Analyzerâ”‚ â”€â”€â”€â”€ æ··åˆæƒ…æ„Ÿåˆ†æžï¼ˆè§„åˆ™ä¼˜å…ˆï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context Check   â”‚ â”€â”€â”€â”€ æ£€æŸ¥ä¸Šä¸‹æ–‡å®¹é‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€ è¶…è¿‡é˜ˆå€¼ â”€â”€â”€â”€â”€â”€â–¶ è§¦å‘æ‘˜è¦ç”Ÿæˆ
      â”‚                         â”‚
      â”‚                         â–¼
      â”‚                  æ›´æ–° Working Context
      â”‚                  å½’æ¡£æ—§æ¶ˆæ¯åˆ° Storage
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM Processor   â”‚ â”€â”€â”€â”€ ç”Ÿæˆå“åº”å’Œå‡½æ•°è°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Function Executorâ”‚ â”€â”€â”€â”€ æ‰§è¡Œè®°å¿†æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Output â”‚ â”€â”€â”€â”€ è¿”å›žå“åº”ç»™ç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è®°å¿†æ£€ç´¢æµç¨‹

```
éœ€è¦åŽ†å²ä¿¡æ¯
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥ Working Context â”‚ â”€â”€â”€â”€ æœ€å¿«ï¼Œçƒ­æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ æœªæ‰¾åˆ°
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FTS5 å…¨æ–‡æœç´¢       â”‚ â”€â”€â”€â”€ å…³é”®è¯åŒ¹é…åŽ†å²è®°å½•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ æœªæ‰¾åˆ°æˆ–éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQL ç»“æž„åŒ–æŸ¥è¯¢       â”‚ â”€â”€â”€â”€ æŒ‰æ—¶é—´/æƒ…æ„Ÿç±»åž‹/äº‹ä»¶æŸ¥è¯¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿¡æ¯åˆ†é¡µè¿”å›ž         â”‚ â”€â”€â”€â”€ é¿å…ä¸Šä¸‹æ–‡æº¢å‡º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯é€‰åž‹

| ç»„ä»¶ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜Ž |
|------|----------|------|
| è¯­è¨€æ¨¡åž‹ | åƒé—® qwen-max | æ”¯æŒå‡½æ•°è°ƒç”¨ï¼Œå…¼å®¹OpenAIæŽ¥å£ |
| å…³ç³»æ•°æ®åº“ | SQLite + FTS5 | æœ¬åœ°æŒä¹…åŒ– + å…¨æ–‡æœç´¢ |
| å‘é‡æœç´¢ | æš‚ä¸å¼•å…¥ï¼ˆå¯é€‰ sqlite-vecï¼‰ | MVPé˜¶æ®µç”¨FTS5æ›¿ä»£ |
| Webæ¡†æž¶ | Gradio | å¯¹è¯å¼UI |
| å¼‚æ­¥æ¡†æž¶ | asyncio | å¼‚æ­¥å¤„ç† |
| é…ç½®ç®¡ç† | python-dotenv | çŽ¯å¢ƒå˜é‡ç®¡ç† |

### å‘é‡æœç´¢æ¼”è¿›è·¯å¾„

```
é˜¶æ®µ1 (MVP)
â””â”€â”€ SQLite FTS5 å…¨æ–‡æœç´¢ âœ… å½“å‰

é˜¶æ®µ2 (å¦‚éœ€è¯­ä¹‰æœç´¢)
â””â”€â”€ sqlite-vec æ‰©å±•
    - ä¼˜ç‚¹ï¼šæ— éœ€é¢å¤–æœåŠ¡ï¼Œä¸ŽSQLiteæ— ç¼é›†æˆ
    - å®‰è£…ï¼špip install sqlite-vec

é˜¶æ®µ3 (å¤§è§„æ¨¡éƒ¨ç½²)
â””â”€â”€ ChromaDB / Qdrant
    - ä¼˜ç‚¹ï¼šä¸“ä¸šå‘é‡æ•°æ®åº“ï¼Œæ€§èƒ½æ›´å¼º
    - é€‚ç”¨ï¼šå¤šç”¨æˆ·ã€æµ·é‡æ•°æ®åœºæ™¯
```

---

## å®‰å…¨ä¸Žéšç§

1. **å¯†é’¥å®‰å…¨**ï¼šAPIå¯†é’¥é€šè¿‡çŽ¯å¢ƒå˜é‡ç®¡ç†ï¼Œä¸æäº¤åˆ°ä»£ç ä»“åº“
2. **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®æœ¬åœ°åŠ å¯†å­˜å‚¨
3. **éšç§ä¿æŠ¤**ï¼šä¸ä¸Šä¼ ç”¨æˆ·éšç§åˆ°äº‘ç«¯
4. **è¾¹ç•Œè®¾å®š**ï¼šè¯†åˆ«å±æœºæƒ…å†µï¼Œæä¾›ä¸“ä¸šèµ„æº
5. **ä¼¦ç†å‡†åˆ™**ï¼šä¸æ›¿ä»£ä¸“ä¸šå¿ƒç†å’¨è¯¢

---

## çŽ¯å¢ƒé…ç½®

### .env.example
```bash
# LLM API é…ç½®
DASHSCOPE_API_KEY=your_api_key_here

# æ•°æ®åº“é…ç½®ï¼ˆå¯é€‰ï¼‰
DATABASE_PATH=./data/emotional_bot.db

# æ—¥å¿—çº§åˆ«ï¼ˆå¯é€‰ï¼‰
LOG_LEVEL=INFO
```

### .gitignore å¿…é¡»åŒ…å«
```
.env
*.db
data/
__pycache__/
```

---

## ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

1. [ ] é¡¹ç›®åˆå§‹åŒ–ä¸ŽçŽ¯å¢ƒé…ç½®
2. [ ] å®žçŽ°æ ¸å¿ƒ EmotionalAgent ç±»
3. [ ] å®žçŽ° SQLite + FTS5 å­˜å‚¨å±‚
4. [ ] å®žçŽ°æ··åˆæƒ…æ„Ÿåˆ†æžå¼•æ“Ž
5. [ ] å®žçŽ°è®°å¿†ç®¡ç†ä¸Žä¸Šä¸‹æ–‡æŽ§åˆ¶
6. [ ] å¼€å‘ Gradio ç”¨æˆ·ç•Œé¢
7. [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
8. [ ] ä¼˜åŒ–å’Œè°ƒè¯•
