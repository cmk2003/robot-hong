# 部署指南

## 系统要求

- Docker 20.10+
- Docker Compose 2.0+
- 2核2G 内存以上

---

## 快速开始（Docker 部署）

### 1. 准备配置文件

```bash
cd robot-hong

# 创建 .env 文件
cat > .env << 'EOF'
# LLM 配置（二选一）
LLM_PROVIDER=qwen
DASHSCOPE_API_KEY=你的千问API密钥
# DEEPSEEK_API_KEY=你的DeepSeek密钥

# Agent 模式 (single/multi)
AGENT_MODE=single

# 激活码（重要！用于验证用户身份）
ACTIVATION_CODE=你的激活码

# 日志级别
LOG_LEVEL=INFO
EOF
```

### 2. 构建并启动

```bash
# 构建镜像
docker compose build

# 启动服务
docker compose up -d

# 查看日志
docker compose logs -f
```

### 3. 访问服务

打开浏览器访问：`http://你的服务器IP:7860`

用户需要输入：
- **用户名**：任意名字（用于区分不同用户的数据）
- **激活码**：你在 `.env` 中配置的 `ACTIVATION_CODE`

---

## 环境变量说明

| 变量名 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `LLM_PROVIDER` | LLM 提供商 (qwen/deepseek) | qwen | 否 |
| `DASHSCOPE_API_KEY` | 千问 API Key | - | 是* |
| `DEEPSEEK_API_KEY` | DeepSeek API Key | - | 是* |
| `ACTIVATION_CODE` | 用户激活码 | - | **强烈建议** |
| `AGENT_MODE` | Agent 模式 (single/multi) | single | 否 |
| `LOG_LEVEL` | 日志级别 (DEBUG/INFO/WARNING/ERROR) | INFO | 否 |
| `GRADIO_SERVER_PORT` | 服务端口 | 7860 | 否 |

> \* `DASHSCOPE_API_KEY` 和 `DEEPSEEK_API_KEY` 根据 `LLM_PROVIDER` 配置选择其一

---

## 多用户功能说明

### 用户隔离

- 每个用户名对应独立的数据空间
- 用户 A 无法看到用户 B 的对话历史和记忆
- 用户名不区分大小写（`Alice` 和 `alice` 是同一用户）

### 激活码验证

- 所有用户必须输入正确的激活码才能使用
- 如果未配置 `ACTIVATION_CODE`，任何人都可以访问（不推荐）
- 激活码对所有用户相同，用于限制访问权限

### 数据持久化

```
robot-hong/
├── data/                    # 数据库目录（自动创建）
│   └── emotional_bot.db     # SQLite 数据库
└── logs/                    # 日志目录（自动创建）
    └── robot-hong.log       # 应用日志（自动轮转，单文件最大10MB）
```

---

## 常用运维命令

### 查看日志

```bash
# Docker 日志
docker compose logs -f

# 应用日志文件
tail -f logs/robot-hong.log
```

### 重启服务

```bash
docker compose restart
```

### 停止服务

```bash
docker compose down
```

### 更新版本

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker compose build
docker compose up -d
```

### 备份数据

```bash
# 备份数据库
cp data/emotional_bot.db backup/emotional_bot_$(date +%Y%m%d).db

# 备份日志
cp -r logs/ backup/logs_$(date +%Y%m%d)/
```

---

## 生产环境建议

### 1. 修改激活码

使用强密码作为激活码：

```bash
# 生成随机激活码
openssl rand -base64 16
```

### 2. 防火墙配置

```bash
# 仅允许特定IP访问
ufw allow from 你的IP to any port 7860

# 或使用 iptables
iptables -A INPUT -p tcp --dport 7860 -s 你的IP -j ACCEPT
iptables -A INPUT -p tcp --dport 7860 -j DROP
```

### 3. 使用反向代理（可选）

如需 HTTPS 或域名访问，可配置 Nginx：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:7860;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }
}
```

---

## 常见问题

### 1. 激活码验证失败

**原因**：激活码输入错误或环境变量未正确配置

**解决**：
```bash
# 检查环境变量
docker compose exec robot-hong env | grep ACTIVATION_CODE

# 重新配置后重启
docker compose restart
```

### 2. 用户数据不持久

**原因**：数据卷未正确挂载

**解决**：
```bash
# 检查卷挂载
docker compose exec robot-hong ls -la /app/data

# 确保 docker-compose.yml 中有正确的 volumes 配置
```

### 3. API Key 配置错误

```
ValueError: 未设置API密钥: DASHSCOPE_API_KEY
```

**解决**：检查 `.env` 文件中的 API Key 配置是否正确

### 4. 内存不足（2G 服务器）

**优化建议**：
- 使用 `AGENT_MODE=single`（单 Agent 模式更省内存）
- 使用更小的模型（如 qwen-turbo）
- 减少同时在线用户数

### 5. 端口被占用

```bash
# 查看端口占用
lsof -i :7860

# 修改 docker-compose.yml 中的端口映射
ports:
  - "8080:7860"  # 改为 8080
```

---

## 目录结构

```
robot-hong/
├── src/                     # 源代码
│   ├── main.py             # 主入口（多用户版）
│   ├── config.py           # 配置管理
│   ├── agent/              # Agent 模块
│   │   ├── agent_pool.py   # Agent 实例池（多用户管理）
│   │   ├── emotional_agent.py
│   │   └── memory.py
│   ├── llm/                # LLM 接口
│   ├── storage/            # 数据存储
│   └── utils/              # 工具模块
│       └── logger.py       # 日志（支持文件输出）
├── data/                   # 数据目录（运行时创建）
├── logs/                   # 日志目录（运行时创建）
├── Dockerfile              # Docker 镜像配置
├── docker-compose.yml      # Docker Compose 配置
├── requirements.txt        # Python 依赖
└── .env                    # 环境变量（需手动创建）
```
