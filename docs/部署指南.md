# 部署指南

## 本地开发

### 1. 环境准备

```bash
# 使用conda环境
conda activate ai-study-env

# 或创建新环境
conda create -n robot-hong python=3.9
conda activate robot-hong
pip install -r requirements.txt
```

### 2. 配置API Key

```bash
# 复制配置文件
cp .env.example .env

# 编辑.env文件，填入真实的API Key
# DASHSCOPE_API_KEY=sk-xxx  # 千问
# 或
# DEEPSEEK_API_KEY=sk-xxx   # DeepSeek
# LLM_PROVIDER=deepseek     # 切换提供商
```

### 3. 启动应用

```bash
# 方式1: 使用启动脚本
chmod +x run.sh
./run.sh

# 方式2: 直接运行
python src/main.py
```

### 4. 访问应用

打开浏览器访问：http://127.0.0.1:7860

---

## 服务器部署（2核2G）

### 1. 上传代码

```bash
# 使用scp上传
scp -r robot-hong/ user@server:/app/

# 或使用git
git clone <仓库地址> /app/robot-hong
```

### 2. 安装依赖

```bash
cd /app/robot-hong

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 配置环境变量

```bash
# 创建生产环境配置
cat > .env << EOF
ENV=production
LLM_PROVIDER=qwen
DASHSCOPE_API_KEY=你的API密钥
DATABASE_PATH=/app/robot-hong/data/emotional_bot.db
LOG_LEVEL=INFO
GRADIO_SERVER_PORT=7860
EOF
```

### 4. 使用systemd管理（推荐）

```bash
# 创建服务文件
sudo cat > /etc/systemd/system/robot-hong.service << EOF
[Unit]
Description=情感陪伴机器人
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/app/robot-hong
Environment=PATH=/app/robot-hong/venv/bin
ExecStart=/app/robot-hong/venv/bin/python src/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable robot-hong
sudo systemctl start robot-hong

# 查看状态
sudo systemctl status robot-hong

# 查看日志
sudo journalctl -u robot-hong -f
```

### 5. 使用Nginx反向代理（可选）

```nginx
# /etc/nginx/sites-available/robot-hong
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:7860;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/robot-hong /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 使用Docker部署（可选）

### Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY src/ src/
COPY .env.example .env

EXPOSE 7860

CMD ["python", "src/main.py"]
```

### 构建和运行

```bash
# 构建镜像
docker build -t robot-hong .

# 运行容器
docker run -d \
  --name robot-hong \
  -p 7860:7860 \
  -v $(pwd)/data:/app/data \
  -e DASHSCOPE_API_KEY=你的API密钥 \
  -e ENV=production \
  robot-hong
```

---

## 常见问题

### 1. API Key配置错误

```
ValueError: 未设置API密钥: DASHSCOPE_API_KEY
```

**解决**: 检查 `.env` 文件中的API Key配置

### 2. 端口被占用

```
OSError: [Errno 98] Address already in use
```

**解决**: 修改 `.env` 中的 `GRADIO_SERVER_PORT` 或关闭占用端口的进程

### 3. 内存不足（2G服务器）

**优化建议**:
- 减少 `MAX_QUEUE_SIZE`（src/agent/memory.py）
- 使用更小的模型（如 qwen-turbo）
- 关闭不必要的后台进程

### 4. 数据库锁定

```
sqlite3.OperationalError: database is locked
```

**解决**: 确保只有一个进程访问数据库，或重启应用

---

## 运维命令

```bash
# 查看日志
tail -f /var/log/robot-hong.log

# 重启服务
sudo systemctl restart robot-hong

# 备份数据
cp /app/robot-hong/data/emotional_bot.db /backup/

# 查看资源占用
htop
```

